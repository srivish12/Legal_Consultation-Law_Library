{% extends 'base.html' %}
{% load static %}
{% load review_extras %}

{% block title %}LegalHub | Legal Consultation & Law Library{% endblock %}

{% block meta %}
<meta name="description"
    content="Your one-stop platform for legal consultations, lawyer search, consultation packages, and a comprehensive law library.">
<meta name="keywords"
    content="Legal Consultation, Find Lawyer, Consultation Packages, Law Library, Legal Advice, Legal Services">
{% endblock %}

{% block corecss %}
{{ block.super }}
<style>
    body {
        background: url('/media/law_office_home1.jpg') no-repeat center center fixed;
        background-size: cover;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .hero-overlay {
        background: rgba(0, 0, 0, 0.65);
        border-radius: 1rem;
    }

    .feature-card {
        transition: transform .2s ease, box-shadow .2s ease;
    }

    .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 1rem 2rem rgba(0, 0, 0, .15);
    }


    #package-carousel::-webkit-scrollbar {
        display: none;
        /* Hide scrollbar */

    }

    .package-review-card {
        transition: transform .2s ease, box-shadow .2s ease;
        background: rgba(194, 241, 133, 0.896);
    }

    .package-review-card .card {
        max-height: none;
        overflow: visible;
        box-shadow: 0 1rem 2rem rgba(0, 0, 0, .15);
    }

    .package-review-card:hover {
        transform: scale(1.05);

    }

    .bg.text-red {
        background-color: #bd3c14;
        padding: 0.2rem 0.5rem;
        border-radius: 0.3rem;
    }

    .bg1 {
        background: wheat;
        border-radius: 1rem;
        opacity: 0.95;
    }
</style>

{% endblock %}

{% block content %}
<div class="container py-5">

    <!-- Hero Section -->
    <div class="row align-items-center mb-5">
        <div class="col-lg-7 mx-auto">
            <div class="hero-overlay p-5 text-white text-center">
                <h1 class="display-5 fw-bold mb-3">
                    Legal Consultation Made Simple
                </h1>
                <p class="lead mb-4">
                    Find trusted lawyers, book consultations, manage legal documents,
                    and explore our comprehensive law library — all in one place.
                </p>
                <div>
                    <a href="{% url 'search_lawyer' %}" class="btn btn-primary btn-lg me-2">
                        Find a Lawyer
                    </a>
                    <a href="{% url 'package_list' %}" class="btn btn-outline-light btn-lg">
                        View Packages
                    </a>
                </div>
                <p class="mt-3 fw-semibold text-warning">
                    <legend>Subscribe today & get 50% off packages!</legend>
                </p>
            </div>
        </div>
    </div>

    <!--free law library section-->
    <div class="row align-items-center mb-5">
        <div class="col-11 mx-auto">
            <div class="hero-overlay hero-3-1 text-white text-center d-flex align-items-center">
                <div class="container">
                    <h2 class="display-5 bg text-red fw-bold mb-3">
                        Explore Our Free Law Library
                    </h2>
                    <p class="lead mb-4">
                        Access a wide range of legal resources, articles, and case studies
                        to empower yourself with knowledge.
                    </p>
                    <a href="{% url 'book_list' %}" class="btn btn-warning btn-lg">
                        Browse Law Library
                    </a>
                </div>
            </div>
        </div>
    </div>


    <!-- Subscription Section -->
    <div class="row mb-5">
        <div class="col-lg-10  mx-auto">
            <div class="card bg1 p-4 shadow-sm">
                <h3 class="text-center mb-4">Subscription Benefits</h3>
                <div class="row text-center">
                    <div class="col-md-4 mb-3">
                        <h5>No Subscription</h5>
                        <p class="text-muted">Pay standard package prices</p>
                    </div>
                    <div class="col-md-4 mb-3">
                        <h5>Basic Subscription</h5>
                        <p class="fw-semibold text-success">
                            30% discount on consultation packages
                        </p>
                    </div>
                    <div class="col-md-4 mb-3">
                        <h5>Full Subscription</h5>
                        <p class="fw-semibold text-success">
                            50% discount on consultation packages
                        </p>
                    </div>
                </div>
                <a href="{% url 'subscriptions:list' %}"
                    class=" btn btn-danger w-50 text-center text-decoration-none d-block mx-auto mt-3">
                    Check Prices
                </a>

            </div>
        </div>
    </div>

    <!-- Call to Action -->
    <div class="text-center py-4">
        {% if user.is_authenticated %}
        <div>
            <h3 class="d-inline-block mb-3 bg-white text-dark p-2 rounded bg-opacity-75">
                Welcome back, {{ user.username }}!
            </h3>
        </div>
        <a href="{% url 'search_lawyer' %}" class="btn btn-success btn-lg">
            Start a Consultation
        </a>
        {% else %}
        <h4 class="mb-3 text-white">
            Get started with LegalHub today
        </h4>
        <a href="/accounts/signup/" class="btn btn-success btn-lg me-2">
            Register
        </a>
        <a href="/accounts/login/" class="btn btn-outline-light btn-lg">
            Login
        </a>
        {% endif %}
    </div>


    <!-- Latest Package Reviews -->
    <div class="my-5 bg-secondary bg-opacity-60 p-3 rounded">
        <h2 class="text-white mb-3">What Clients Say About Our Packages</h2>

        <div class="position-relative">
            <!-- Left Arrow -->
            <button id="scroll-left" class="btn btn-light position-absolute top-50 start-0 translate-middle-y"
                style="z-index: 10;">
                &#8249;
            </button>

            <!-- Scrollable Container -->
            <div id="package-carousel" class="d-flex overflow-auto py-3" style="scroll-behavior: smooth; gap: 1rem;">
                {% for review in latest_package_reviews %}
                <div class="card package-review-card p-3" style="min-width: 300px; flex: 0 0 auto;">
                    <h5>{{ review.package.title }}</h5>
                    <p class="text-muted">Lawyer: {{ review.package.lawyer.name }}</p>
                    <p>{% for i in review.rating|star_range %}⭐{% endfor %}</p>
                    <p>{{ review.comment }}</p>
                    <small class="text-muted">— {{ review.user.username }}</small>
                </div>
                {% empty %}
                <p class="text-white">***No package reviews yet.***</p>

                {% endfor %}
            </div>

            <!-- Right Arrow -->
            <button id="scroll-right" class="btn btn-light position-absolute top-50 end-0 translate-middle-y"
                style="z-index: 10;">
                &#8250;
            </button>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}

{{ block.super }}

<script>
    document.addEventListener('DOMContentLoaded', function () {

        const carousel = document.getElementById('package-carousel');
        const leftBtn = document.getElementById('scroll-left');
        const rightBtn = document.getElementById('scroll-right');

        const scrollAmount = 320; // card width + gap
        let page = 2; // initial page already rendered is page 1
        let loading = false;
        let hasNext = true;

        // Scroll buttons
        leftBtn.addEventListener('click', () => {
            carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        });

        rightBtn.addEventListener('click', async () => {
            carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });

            // If scrolled near end and more pages exist, load next
            if (!loading && hasNext) {
                const maxScroll = carousel.scrollWidth - carousel.clientWidth;
                if (carousel.scrollLeft + scrollAmount >= maxScroll - 50) {
                    await loadMoreReviews();
                }
            }
        });

        async function loadMoreReviews() {
            loading = true;

            try {
                const res = await fetch(`/reviews/load-more-package-reviews/?page=${page}`);
                if (!res.ok) throw new Error('Network error');

                const data = await res.json();

                data.reviews.forEach(review => {
                    const stars = '⭐'.repeat(review.rating);

                    const html = `
                <div class="card package-review-card p-3" style="min-width: 300px; flex: 0 0 auto;">
                    <h5>${review.package}</h5>
                    <p class="text-muted">Lawyer: ${review.lawyer}</p>
                    <p>${stars}</p>
                    <p>${review.comment}</p>
                    <small class="text-muted">— ${review.user}</small>
                </div>
                `;
                    carousel.insertAdjacentHTML('beforeend', html);
                });

                hasNext = data.has_next;
                page++;

                // Hide right arrow if no more pages
                if (!hasNext) rightBtn.style.display = 'none';

            } catch (error) {
                console.error('Error loading more reviews:', error);
            } finally {
                loading = false;
            }
        }

        // Optional: auto load more as user scrolls manually
        carousel.addEventListener('scroll', () => {
            if (!loading && hasNext) {
                const maxScroll = carousel.scrollWidth - carousel.clientWidth;
                if (carousel.scrollLeft >= maxScroll - 50) {
                    loadMoreReviews();
                }
            }
        });

    });
</script>


{% endblock %}